# Cellular Ratio预防性拥塞控制策略

## 核心理念：预防优于治疗

### 传统WebRTC拥塞控制的问题
- **被动响应**：等到检测到overuse（延迟增加）才降速
- **反应滞后**：overuse发生时，队列已经积累，用户已经感受到卡顿
- **恢复缓慢**：一旦触发overuse，需要时间清空队列并恢复

### Cellular Ratio的预防性策略
- **主动预防**：基于BSR ratio提前判断网络容量
- **避免overuse**：在资源紧张时限制增长，防止触发overuse
- **平滑控制**：通过渐进式调整避免剧烈波动

## 实现的两层预防机制

### 1. 保守增长层（ratio: 0.7-0.9）
```cpp
bool ShouldLimitIncrease() const {
  // ratio < 0.9 或检测到负趋势时
  // 限制为加性增长，避免激进的乘法增长
}
```

**作用**：
- 当ratio在0.7-0.9之间，说明资源开始紧张
- 限制为加性增长（线性增长），避免指数增长
- 即使ratio还可以，但如果检测到下降趋势，也要保守

**效果**：
- 防止快速耗尽剩余资源
- 给网络恢复的时间
- 减少触发overuse的概率

### 2. 预防性保持层（ratio < 0.7）
```cpp
bool ShouldForceHold() const {
  // ratio < 0.7时返回true
  // 将Increase状态改为Hold
}
```

**作用**：
- 当ratio低于0.7，说明资源严重受限
- 阻止任何增长，保持当前码率
- 不主动降速，让WebRTC的overuse检测决定是否需要降速

**效果**：
- 防止继续增加网络负载
- 给基站分配更多资源的机会
- 如果还是触发overuse，WebRTC会自动降速

## 为什么不强制DECREASE？

1. **WebRTC已有完善的降速机制**
   - TrendlineEstimator检测延迟趋势
   - 一旦检测到overuse会自动触发decrease
   - 我们不需要重复这个功能

2. **预防更有效**
   - 通过限制增长避免达到overuse点
   - 保持在网络容量之内运行
   - 用户体验更平滑

3. **避免过度反应**
   - BSR ratio可能有噪声
   - 强制降速可能导致带宽利用不足
   - 让WebRTC的延迟检测做最终决策

## 参数阈值设计

| Ratio范围 | 策略 | 原因 |
|-----------|------|------|
| ≥ 0.9 | 正常AIMD | 资源充足，可以正常增长 |
| 0.7-0.9 | 限制为加性增长 | 资源开始紧张，保守增长 |
| < 0.7 | 保持当前码率 | 资源受限，停止增长防止overuse |
| 检测到overuse | WebRTC自动降速 | 预防失败，启动治疗机制 |

## 趋势检测的重要性

```cpp
double trend = smoothed_cellular_ratio_ - previous_ratio_;
bool negative_trend = trend < -0.02;  // 轻微负趋势
```

- 即使当前ratio还可以（如0.85），但如果在下降，也要保守
- 提前响应恶化趋势，不等到ratio真的很低
- 趋势阈值-0.02表示2%的下降就触发保守策略

## 数据平滑

```cpp
const double kSmoothingAlpha = 0.1;
smoothed_ratio = 0.1 * new_ratio + 0.9 * old_smoothed_ratio;
```

- 避免单个异常值导致策略突变
- 平滑系数0.1提供稳定性
- 仍然能够响应持续的变化趋势

## 预期效果

### 传统WebRTC（无Cellular Ratio）
```
时间 →
码率:  ↗↗↗↗ (激进增长) → 💥 (overuse) → ↘↘ (降速) → 恢复
延迟:  ————————————————— ↗↗↗ (队列积累) → ↘↘
用户:  😊😊😊😊😊😊😊😊😊😊 😖😖😖 (卡顿) → 😊
```

### 使用Cellular Ratio预防策略
```
时间 →
码率:  ↗↗ (正常增长) → — (保持) → ↗ (恢复增长)
延迟:  ———————————————————————————— (稳定)
用户:  😊😊😊😊😊😊😊😊😊😊😊😊😊 (流畅)
BSR:   1.0 → 0.8 → 0.6 → 0.7 → 0.9 → 1.0
```

## 测试验证点

1. **ratio = 0.95 → 0.85**
   - 应该看到：从乘法增长切换到加性增长
   - 日志：`[AIMD-Cellular] Limiting to additive increase`

2. **ratio = 0.75 → 0.65**
   - 应该看到：从Increase状态变为Hold
   - 日志：`[AIMD-Cellular] Preventive HOLD`

3. **ratio = 0.5但延迟正常**
   - 应该看到：保持Hold，不强制降速
   - 如果延迟增加，WebRTC自己会触发decrease

4. **ratio恢复到0.9**
   - 应该看到：恢复正常AIMD增长
   - 可能触发快速恢复

## 总结

Cellular Ratio的预防性策略通过提前限制增长来避免网络拥塞，而不是等到拥塞发生后再降速。这种方法可以：

1. **减少延迟峰值** - 防止队列积累
2. **提高用户体验** - 避免卡顿
3. **更好的带宽利用** - 在容量范围内稳定运行
4. **与WebRTC协同** - 不替代而是增强现有机制

关键是要记住：我们的目标是**预防overuse**，而不是**处理overuse**。