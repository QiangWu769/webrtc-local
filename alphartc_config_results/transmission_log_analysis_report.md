# AlphaRTC传输日志分析报告

## 🎯 问题描述
通过对比发送端和接收端视频文件发现严重的质量损失：
- **文件大小损失**: 28.5% (196M → 141M)
- **帧数损失**: 28.47% (446帧 → 319帧，丢失127帧)  
- **时长损失**: 4.23秒 (14.83秒 → 10.60秒)

## 🔍 调查过程

### 1. 初步假设
- ❌ 编码器质量问题
- ❌ 网络丢包
- ❌ 帧压缩算法问题

### 2. 日志文件分析

#### 📁 可用日志
- `server.log`: 1行 - 服务器启动失败，使用P2P模式
- `sender.log`: 3178行 - 发送端详细日志
- `receiver.log`: 3163行 - 接收端详细日志

#### 🔍 关键发现

**编码器配置问题**:
```
ERROR: Initial encoder max bitrate = -1 which is <= 0!
```
- 发现次数: 发送端1次，接收端1次
- 影响: 导致自动码率管理，但不是主要问题

**明确的帧丢弃事件**:
```
(video_stream_encoder.cc:1129): Dropping frame. Too large for target bitrate.
```
- 发送端: 2次明确记录
- 接收端: 0次
- 结论: 明确丢帧事件无法解释127帧的巨大损失

### 3. 突破性发现

#### ⏰ 时间线分析
- **配置传输时间**: 15秒
- **发送端实际时长**: 14.83秒 (446帧)
- **接收端实际时长**: 10.60秒 (319帧)
- **时间差**: 4.23秒
- **理论计算**: 127帧 ÷ 30fps = 4.233秒 ✅

#### 🎯 根本原因确认

**接收端日志关键证据**:
```
(conductor.cc:356): ⏰ AlphaRTC auto-close timer triggered, closing connection
(conductor.cc:730): DisconnectFromCurrentPeer
```

**配置对比**:
- 发送端autoclose: 15秒
- 接收端autoclose: 20秒  
- 实际触发时间: ~10.60秒

## 🎊 最终结论

### ✅ 质量损失根本原因
**Auto-close定时器配置/实现问题导致连接提前断开**

1. **不是编码质量问题**: 每帧像素数据完整，只是数量不足
2. **不是网络传输问题**: 接收端报告0丢帧
3. **是配置不匹配问题**: AlphaRTC内部使用了更短的超时时间

### 📊 数据完整性验证
- **帧数量追踪**: 446帧(发送) → 319帧(接收) = 127帧丢失
- **时间计算**: 127帧 ÷ 30fps = 4.233秒 = 实际时间差
- **像素质量**: 每个接收帧都是完整的Y4M格式，无损坏

### 💡 解决方案建议

1. **统一配置**: 确保发送端和接收端使用相同的传输时间
2. **增加余量**: 设置传输时间大于实际需要时间
3. **代码修复**: 检查AlphaRTC中auto-close的实际实现逻辑
4. **监控机制**: 添加更详细的时间和帧数统计日志

## 🛠️ 技术细节

### 编码器状态
- 使用VP8主编解码器
- 自动码率管理启用
- 支持多种现代编解码器(VP9, AV1X)

### 网络传输
- P2P直连模式
- 启用transport-cc反馈
- RTX重传机制
- NACK/PLI错误恢复

### 文件格式
- 输出格式: Y4M (YUV4MPEG2)
- 分辨率: 640x480
- 帧率: 30fps
- 色彩空间: YUV420

## 📈 质量评估
- **格式兼容性**: ✅ 完美
- **分辨率保持**: ✅ 完美  
- **帧率保持**: ✅ 完美
- **像素完整性**: ✅ 完美
- **时间连续性**: ❌ 受损 (28.5%时长丢失)

这是一个典型的**配置问题而非技术质量问题**。