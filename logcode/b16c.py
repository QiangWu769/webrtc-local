import struct
import sys
from hdlc import HDLC  # <-- 必须使用您提供的hdlc.py

def get_tbs_index_string(tbs_index: int) -> str:
    """将TBS索引号转换为其字符串表示形式。"""
    TBS_MAP = {
    0: "TBS_Index_0", 1: "TBS_Index_1", 2: "TBS_Index_2", 3: "TBS_Index_3",
    4: "TBS_Index_4", 5: "TBS_Index_5", 6: "TBS_Index_6", 7: "TBS_Index_7",
    8: "TBS_Index_8", 9: "TBS_Index_9", 10: "TBS_Index_10", 11: "TBS_Index_11",
    12: "TBS_Index_12", 13: "TBS_Index_13", 14: "TBS_Index_14", 15: "TBS_Index_15",
    16: "TBS_Index_16", 17: "TBS_Index_17", 18: "TBS_Index_18", 19: "TBS_Index_19",
    20: "TBS_Index_20", 21: "TBS_Index_21", 22: "TBS_Index_22", 23: "TBS_Index_23",
    24: "TBS_Index_24", 25: "TBS_Index_25", 26: "TBS_Index_26", 27: "TBS_Index_26A",
    28: "TBS_Index_27", 29: "TBS_Index_28", 30: "TBS_Index_29", 31: "TBS_Index_30",
        32: "TBS_Index_31", 33: "TBS_Index_32", 34: "TBS_Index_32A", 35: "TBS_Index_33"
    }
    return TBS_MAP.get(tbs_index, "invalid")

def decode_b16c_payload(payload: bytes, timestamp: int, logcode: int) -> list:
    """解码0xB16C日志的具体载荷。"""
    parsed_records = []
    if len(payload) < 4: return []
    version = payload[0]
    num_records = (payload[1] & 0xFC) >> 2
    payload_view = memoryview(payload)
    cursor = 4
    for i in range(num_records):
        if cursor + 128 > len(payload_view): break
        h1, h2 = payload_view[cursor], payload_view[cursor + 1]
        subfn = (h2 & 0x3C) >> 2
        sysfn = ((h2 & 0x03) << 8) | h1
        num_ul_grant = (h2 & 0xC0) >> 6
        cursor += 2
        if num_ul_grant != 0:
            ul_grant_view = payload_view[cursor : cursor + 126]
            mcs_index = (ul_grant_view[5] & 0xF8) >> 3
            redundancy_version = (ul_grant_view[5] & 0x06) >> 1
            tbs_index = ul_grant_view[6] & 0x3F
            num_of_resource_blocks = ul_grant_view[8] & 0x7F
            record_data = {
                "logcode": f"0x{logcode:X}", "timestamp": timestamp, "version": version,
                "subfn": subfn, "sysfn": sysfn, "mcs_index": mcs_index,
                "redundancy_version": redundancy_version, "tbs_string": get_tbs_index_string(tbs_index),
                "num_of_resource_blocks": num_of_resource_blocks, "is_ul_grant": 1
            }
            parsed_records.append(record_data)
        cursor += 126
    return parsed_records

def process_diag_data(raw_hex_string: str, output_filename: str):
    """主处理函数，严格遵循HDLC协议。"""
    try:
        full_data = bytes.fromhex(raw_hex_string.replace("\n", "").replace(" ", ""))
    except ValueError:
        print("错误: 输入的十六进制字符串格式不正确。", file=sys.stderr)
        return
    all_results = []
    potential_frames = full_data.split(b'\x7e')
    for frame_data in potential_frames:
        if not frame_data: continue
        decoded_payload = HDLC.decode(frame_data + b'\x7e')
    if decoded_payload is None:
            # print(f"CRC校验失败或帧无效，已跳过。")
            continue
        if decoded_payload.startswith(b'\x98\x01\x00\x00\x01\x00\x00\x00'):
            data = decoded_payload[8:]
        else:
            continue
        data = data[4:]
        if len(data) < 12: continue
        msg_len, logcode, timestamp = struct.unpack('<HHQ', data[:12])
        if logcode == 0xB16C:
            payload_start = 12
            payload_end = payload_start + msg_len - 12
            payload = data[payload_start:payload_end]
            results = decode_b16c_payload(payload, timestamp, logcode)
            all_results.extend(results)
    if not all_results:
        print("在有效的日志帧中没有找到可解码的0xB16C UL Grant记录。")
        return
    try:
        with open(output_filename, 'w', encoding='utf-8') as f:
            header = ["LogCode", "Timestamp", "Version", "SubFN", "SysFN", "MCS_Index", "RV", "TBS_Index", "Num_RBs", "Is_UL_Grant"]
            f.write("\t".join(header) + "\n")
            for record in all_results:
                line = [str(v) for v in record.values()]
                f.write("\t".join(line) + "\n")
        print(f"成功！已将 {len(all_results)} 条记录写入文件: {output_filename}")
    except IOError as e:
        print(f"错误: 无法写入文件 {output_filename}: {e}", file=sys.stderr)

# --- 主程序入口 ---
if __name__ == '__main__':
    # 使用您最新提供的、CRC完全有效的日志数据
    input_data = """
98 01 00 00 01 00 00 00 10 00 64 00 64 00 64 b0 dc 33 7a 3c 89 b6 0b 01 01 01 12 00 08 02 54 00 04 01 00 00 00 b2 33 69 00 00 64 00 01 04 05 3e 1f 00 00 00 01 00 01 00 c7 33 71 00 00 6c 00 01 04 05 3e 1f 00 00 00 01 00 00 00 22 34 71 00 01 68 00 02 03 07 3d 3a 23 02 1f c0 28 01 00 01 00 37 34 71 00 00 6c 00 01 04 05 3e 1f 00 00 00 19 98 7f 7e 98 01 00 00 01 00 00 00 10 00 10 0a 10 0a 6c b1 da 36 7a 3c 89 b6 0b 01 30 51 00 00 f7 06 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 04 00 00 11 29 18 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 1f 4f 00 00 01 01 12 c0 96 70 04 80 4d 16 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 20 17 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 04 00 00 11 21 70 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 22 03 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 04 00 00 11 21 20 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 23 4f 00 00 61 01 12 c0 96 a0 04 80 cd 17 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 24 63 00 00 61 00 12 b0 94 a0 02 80 4d 0b 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 25 27 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 04 00 00 11 29 68 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 26 63 00 00 81 00 12 b0 94 78 02 80 0d 0a 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 33 4f 00 00 81 01 12 c0 96 58 04 80 8d 15 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 34 17 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 04 00 00 11 21 70 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 36 1b 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 04 00 00 11 29 50 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 37 63 00 00 a1 00 12 b0 94 58 02 80 0d 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 39 4f 00 00 61 01 12 c0 96 58 04 80 8d 15 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 3a 17 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 04 00 00 11 25 70 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 3a 63 00 00 41 00 06 a8 93 58 02 80 0d 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 3c 4f 00 00 41 01 12 b0 94 58 02 80 0d 09 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 40 23 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 04 00 00 11 25 0e 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 41 63 00 00 61 00 12 b0 94 38 02 80 0d 08 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 43 4f 00 00 61 01 12 b0 94 40 02 80 4d 08 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 44 63 00 00 41 00 12 b0 94 40 02 80 4d 08 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 58 ed 7e 98 01 00 00 01 00 00 00 10 00 28 00 28 00 64 b0 6c b1 cb 3c 89 b6 0b 01 01 01 12 00 08 02 18 00 01 01 00 00 00 52 34 71 00 00 6c 00 01 04 05 3e 1f 00 00 00 6f 15 7e 98 01 00 00 01 00 00 00 10 00 90 00 90 00 6c b1 a5 6a fa 3c 89 b6 0b 01 30 05 00 00 46 63 00 00 41 00 12 f4 94 78 02 80 0d 0a 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 1a 8a 7e 
    """
    
    output_file = "b16c_report_final.txt"
    process_diag_data(input_data, output_file)